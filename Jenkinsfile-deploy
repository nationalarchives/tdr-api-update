library("tdr-jenkinslib")

pipeline {
    agent {
        label "master"
    }
    parameters {
        choice(name: "STAGE", choices: ["intg", "staging", "prod"], description: "The stage you are building the api update lambda for")
        string(name: "TO_DEPLOY", description: "The git tag, branch or commit reference to deploy, e.g. '1'")
    }
    stages {
        stage("Deploy lambda") {
            agent {
                ecs {
                    inheritFrom "aws"
                    taskrole "arn:aws:iam::${env.MANAGEMENT_ACCOUNT}:role/TDRJenkinsNodeLambdaRole${params.STAGE.capitalize()}"
                }
            }
            steps {
                script {
                    def accountNumber = tdr.getAccountNumberFromStage(params.STAGE)
                    sh "python3 /deploy_lambda_from_s3.py ${accountNumber} ${params.STAGE} tdr-api-update-${params.STAGE} tdr-backend-code-mgmt ${params.TO_DEPLOY}/api-update.jar"
                }
            }
        }
    }
    success {
      script {
        if (params.STAGE == "intg"){
          tdr.runEndToEndTests(0, params.STAGE, BUILD_URL)
        }
      }
    }
}
